<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingAgents - Intelligente Aktienanalyse</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <h1>TradingAgents</h1>
            </div>
            <p class="subtitle">Multi-Agenten KI-Framework f√ºr Finanzanalysen</p>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Configuration Panel -->
            <div class="config-panel">
                <h2><i class="fas fa-cog"></i> Konfiguration</h2>
                
                <form id="analysisForm">
                    <!-- Ticker & Datum -->
                    <div class="form-section">
                        <h3>Grunddaten</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ticker">
                                    <i class="fas fa-tag"></i> Ticker-Symbol
                                </label>
                                <input type="text" id="ticker" name="ticker" placeholder="z.B. AAPL" required>
                            </div>
                            <div class="form-group">
                                <label for="date">
                                    <i class="fas fa-calendar"></i> Analysedatum
                                </label>
                                <input type="date" id="date" name="date" required>
                            </div>
                        </div>
                    </div>

                    <!-- Analysten Auswahl -->
                    <div class="form-section">
                        <h3>Analysten-Team</h3>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="analystMarket" name="analysts" value="market" checked>
                                <span><i class="fas fa-chart-bar"></i> Marktanalyst</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="analystSocial" name="analysts" value="social">
                                <span><i class="fas fa-users"></i> Social Media Analyst</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="analystNews" name="analysts" value="news" checked>
                                <span><i class="fas fa-newspaper"></i> Nachrichtenanalyst</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="analystFundamentals" name="analysts" value="fundamentals" checked>
                                <span><i class="fas fa-file-invoice-dollar"></i> Fundamentalanalyst</span>
                            </label>
                        </div>
                    </div>

                    <!-- API Keys -->
                    <div class="form-section">
                        <h3>API-Schl√ºssel</h3>
                        <div class="form-group">
                            <label for="openaiKey">
                                <i class="fas fa-key"></i> OpenAI API Key
                            </label>
                            <input type="password" id="openaiKey" name="openaiKey" placeholder="sk-..." required>
                            <small class="hint-text">Wird f√ºr LLM-Agenten ben√∂tigt</small>
                        </div>
                        <div class="form-group">
                            <label for="alphaVantageKey">
                                <i class="fas fa-key"></i> Alpha Vantage API Key
                            </label>
                            <input type="password" id="alphaVantageKey" name="alphaVantageKey" placeholder="Ihr Alpha Vantage Key" required>
                            <small class="hint-text">F√ºr Fundamental- und Nachrichtendaten</small>
                        </div>
                    </div>

                    <!-- Discord Integration (Optional) -->
                    <div class="form-section">
                        <h3>Discord Integration <span class="optional-badge">(Optional)</span></h3>
                        <div class="form-group">
                            <label for="discordWebhook">
                                <i class="fab fa-discord"></i> Discord Webhook URL
                            </label>
                            <input type="url" id="discordWebhook" name="discordWebhook" placeholder="https://discord.com/api/webhooks/...">
                            <small class="hint-text">Ergebnisse werden automatisch an Discord gesendet</small>
                        </div>
                        <div class="checkbox-group-single">
                            <label class="checkbox-label">
                                <input type="checkbox" id="discordNotify" name="discordNotify" checked>
                                <span><i class="fas fa-bell"></i> Bei Abschluss benachrichtigen</span>
                            </label>
                        </div>
                    </div>

                    <!-- LLM Provider -->
                    <div class="form-section">
                        <h3>KI-Modell Konfiguration</h3>
                        <div class="form-group">
                            <label for="provider">
                                <i class="fas fa-server"></i> LLM Provider
                            </label>
                            <select id="provider" name="provider" required>
                                <option value="">Bitte w√§hlen...</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="quickModel">
                                    <i class="fas fa-bolt"></i> Schnelles Modell
                                </label>
                                <select id="quickModel" name="quickModel" required>
                                    <option value="">Zuerst Provider w√§hlen</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="deepModel">
                                    <i class="fas fa-brain"></i> Tiefgehendes Modell
                                </label>
                                <select id="deepModel" name="deepModel" required>
                                    <option value="">Zuerst Provider w√§hlen</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Recherchetiefe -->
                    <div class="form-section">
                        <h3>Recherchetiefe</h3>
                        <div class="form-group">
                            <label for="depth">
                                <i class="fas fa-layer-group"></i> 
                                Tiefe: <span id="depthValue">3</span> Runden
                            </label>
                            <input type="range" id="depth" name="depth" min="1" max="5" value="3" step="1">
                            <div class="depth-labels">
                                <span>Oberfl√§chlich</span>
                                <span>Mittel</span>
                                <span>Tiefgehend</span>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn-primary" id="analyzeBtn">
                        <i class="fas fa-play"></i> Analyse starten
                    </button>
                </form>
            </div>

            <!-- Results Panel -->
            <div class="results-panel">
                <h2><i class="fas fa-chart-pie"></i> Analyseergebnisse</h2>
                
                <div id="loadingState" class="loading-state" style="display: none;">
                    <div class="spinner"></div>
                    <p>Analyse l√§uft...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p class="status-text" id="statusText">Initialisierung...</p>
                </div>

                <div id="resultsContent" class="results-content">
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>Noch keine Analyse durchgef√ºhrt</p>
                        <p class="hint">F√ºllen Sie das Formular aus und starten Sie eine Analyse</p>
                    </div>
                </div>

                <div id="errorState" class="error-state" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p id="errorMessage"></p>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2025 TradingAgents | 
                <a href="https://github.com/TauricResearch" target="_blank">
                    <i class="fab fa-github"></i> GitHub
                </a>
            </p>
        </footer>
    </div>

    <script>
        // TradingAgents Web UI - Inline JavaScript (kein Cache!)
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ TradingAgents UI wird geladen...');
            
            // Form Elements
            const form = document.getElementById('analysisForm');
            const providerSelect = document.getElementById('provider');
            const quickModelSelect = document.getElementById('quickModel');
            const deepModelSelect = document.getElementById('deepModel');
            const depthSlider = document.getElementById('depth');
            const depthValue = document.getElementById('depthValue');
            const dateInput = document.getElementById('date');
            const openaiKeyInput = document.getElementById('openaiKey');
            const alphaVantageKeyInput = document.getElementById('alphaVantageKey');
            const discordWebhookInput = document.getElementById('discordWebhook');
            
            // Debug: √úberpr√ºfe ob alle Elemente gefunden wurden
            console.log('Elements gefunden:', {
                form: !!form,
                providerSelect: !!providerSelect,
                openaiKeyInput: !!openaiKeyInput,
                alphaVantageKeyInput: !!alphaVantageKeyInput,
                discordWebhookInput: !!discordWebhookInput
            });
            
            // State Elements
            const loadingState = document.getElementById('loadingState');
            const resultsContent = document.getElementById('resultsContent');
            const errorState = document.getElementById('errorState');
            const progressFill = document.getElementById('progressFill');
            const statusText = document.getElementById('statusText');

            // Set default date to today
            if (dateInput) {
                dateInput.valueAsDate = new Date();
                console.log('‚úì Datum gesetzt');
            }

            // Load saved configuration and form data
            console.log('üì• Lade gespeicherte Konfiguration...');
            loadSavedConfig();
            loadFormData();

            // Load providers on page load
            console.log('üîå Lade LLM Provider...');
            loadProviders();
            
            // Attach auto-save listeners
            console.log('üîó Richte Auto-Save ein...');
            attachAutoSaveListeners();

            // Depth slider update
            depthSlider.addEventListener('input', function() {
                depthValue.textContent = this.value;
            });

            // Provider change event
            providerSelect.addEventListener('change', async function() {
                const provider = this.value;
                if (provider) {
                    await loadModels(provider);
                }
            });

            // Form submission
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                await startAnalysis();
            });

            // Auto-save API keys when they change (with debounce)
            let saveTimeout;
            [openaiKeyInput, alphaVantageKeyInput, discordWebhookInput].forEach(input => {
                if (input) {
                    input.addEventListener('input', function() {
                        clearTimeout(saveTimeout);
                        saveTimeout = setTimeout(() => {
                            saveConfig();
                        }, 1000);
                    });
                }
            });

            // Load saved configuration from .env
            async function loadSavedConfig() {
                try {
                    console.log('Rufe /api/config auf...');
                    const response = await fetch('/api/config');
                    const config = await response.json();
                    console.log('Konfiguration geladen:', config);
                    
                    if (config.openai_api_key && openaiKeyInput) {
                        openaiKeyInput.value = config.openai_api_key;
                        console.log('‚úì OpenAI Key wiederhergestellt');
                    }
                    if (config.alpha_vantage_api_key && alphaVantageKeyInput) {
                        alphaVantageKeyInput.value = config.alpha_vantage_api_key;
                        console.log('‚úì Alpha Vantage Key wiederhergestellt');
                    }
                    if (config.discord_webhook && discordWebhookInput) {
                        discordWebhookInput.value = config.discord_webhook;
                        console.log('‚úì Discord Webhook wiederhergestellt');
                    }
                } catch (error) {
                    console.error('‚ùå Fehler beim Laden der Konfiguration:', error);
                }
            }

            // Save configuration to .env
            async function saveConfig() {
                try {
                    if (!openaiKeyInput || !alphaVantageKeyInput || !discordWebhookInput) {
                        console.error('Nicht alle Input-Elemente gefunden');
                        return;
                    }

                    const config = {
                        openai_api_key: openaiKeyInput.value.trim(),
                        alpha_vantage_api_key: alphaVantageKeyInput.value.trim(),
                        discord_webhook: discordWebhookInput.value.trim()
                    };

                    console.log('Speichere Konfiguration:', {
                        openai_api_key: config.openai_api_key ? '***' : 'leer',
                        alpha_vantage_api_key: config.alpha_vantage_api_key ? '***' : 'leer',
                        discord_webhook: config.discord_webhook ? '***' : 'leer'
                    });

                    const response = await fetch('/api/save-config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(config)
                    });

                    const result = await response.json();
                    if (result.success) {
                        console.log('‚úÖ Konfiguration erfolgreich gespeichert');
                    } else {
                        console.error('‚ùå Fehler:', result.message);
                    }
                } catch (error) {
                    console.error('‚ùå Fehler beim Speichern der Konfiguration:', error);
                }
            }

            // Load available providers
            async function loadProviders() {
                try {
                    console.log('üì° Rufe /api/providers auf...');
                    const response = await fetch('/api/providers');
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('‚úÖ Provider-Daten empfangen:', data);
                    
                    if (!providerSelect) {
                        console.error('‚ùå providerSelect Element nicht gefunden!');
                        return;
                    }
                    
                    providerSelect.innerHTML = '<option value="">Bitte w√§hlen...</option>';
                    
                    if (!data.providers || !Array.isArray(data.providers)) {
                        console.error('‚ùå Ung√ºltiges Provider-Datenformat:', data);
                        return;
                    }
                    
                    data.providers.forEach(provider => {
                        const option = document.createElement('option');
                        option.value = provider.name;
                        option.textContent = provider.name;
                        option.dataset.url = provider.url;
                        providerSelect.appendChild(option);
                        console.log(`  ‚úì Hinzugef√ºgt: ${provider.name}`);
                    });
                    
                    console.log(`‚úÖ ${data.providers.length} Provider erfolgreich geladen`);
                } catch (error) {
                    console.error('‚ùå Fehler beim Laden der Provider:', error);
                    showError('Fehler beim Laden der Provider: ' + error.message);
                }
            }

            // Load models for selected provider
            async function loadModels(provider) {
                try {
                    console.log(`üì° Lade Modelle f√ºr ${provider}...`);
                    const response = await fetch(`/api/models/${provider}`);
                    const data = await response.json();
                    console.log('Modelle geladen:', data);
                    
                    // Update quick model select
                    quickModelSelect.innerHTML = '<option value="">Bitte w√§hlen...</option>';
                    data.quick.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.value;
                        option.textContent = model.name;
                        quickModelSelect.appendChild(option);
                    });

                    // Update deep model select
                    deepModelSelect.innerHTML = '<option value="">Bitte w√§hlen...</option>';
                    data.deep.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.value;
                        option.textContent = model.name;
                        deepModelSelect.appendChild(option);
                    });

                    // Auto-select first options
                    if (data.quick.length > 0) quickModelSelect.value = data.quick[0].value;
                    if (data.deep.length > 0) deepModelSelect.value = data.deep[0].value;
                    
                    console.log(`‚úÖ ${data.quick.length} Quick + ${data.deep.length} Deep Modelle geladen`);

                } catch (error) {
                    console.error('‚ùå Fehler beim Laden der Modelle:', error);
                    showError('Fehler beim Laden der Modelle: ' + error.message);
                }
            }

            // Start analysis
            async function startAnalysis() {
                const ticker = document.getElementById('ticker').value.trim().toUpperCase();
                const date = document.getElementById('date').value;
                const openaiKey = document.getElementById('openaiKey').value.trim();
                const alphaVantageKey = document.getElementById('alphaVantageKey').value.trim();
                const provider = providerSelect.value;
                const providerUrl = providerSelect.options[providerSelect.selectedIndex].dataset.url;
                const quickModel = quickModelSelect.value;
                const deepModel = deepModelSelect.value;
                const depth = parseInt(depthSlider.value);
                const discordWebhook = document.getElementById('discordWebhook').value.trim();
                const discordNotify = document.getElementById('discordNotify').checked;

                // Get selected analysts
                const analysts = [];
                document.querySelectorAll('input[name="analysts"]:checked').forEach(checkbox => {
                    analysts.push(checkbox.value);
                });

                // Validation
                if (!ticker || !date || !openaiKey || !alphaVantageKey || !provider || !quickModel || !deepModel) {
                    showError('Bitte f√ºllen Sie alle Pflichtfelder aus');
                    return;
                }

                if (analysts.length === 0) {
                    showError('Bitte w√§hlen Sie mindestens einen Analysten aus');
                    return;
                }

                // Prepare request
                const requestData = {
                    ticker: ticker,
                    date: date,
                    analysts: analysts,
                    llm_provider: provider,
                    provider_url: providerUrl,
                    deep_think_model: deepModel,
                    quick_think_model: quickModel,
                    research_depth: depth,
                    openai_api_key: openaiKey,
                    alpha_vantage_api_key: alphaVantageKey,
                    discord_webhook: discordWebhook || null,
                    discord_notify: discordNotify
                };

                // Show loading state
                showLoading();

                try {
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Server error:', errorText);
                        showError(`Server-Fehler (${response.status}): ${errorText.substring(0, 200)}`);
                        return;
                    }

                    const startData = await response.json();
                    
                    if (!startData.success) {
                        showError(startData.message || 'Fehler beim Starten der Analyse');
                        return;
                    }

                    const analysisId = startData.analysis_id;
                    console.log('Analyse gestartet mit ID:', analysisId);

                    simulateProgress();
                    await pollAnalysisResult(analysisId);

                } catch (error) {
                    console.error('Fehler bei der Analyse:', error);
                    showError('Fehler bei der Kommunikation mit dem Server: ' + error.message);
                }
            }

            // Poll for analysis results
            async function pollAnalysisResult(analysisId) {
                const maxAttempts = 180;
                let attempts = 0;

                const poll = async () => {
                    try {
                        const response = await fetch(`/api/analysis/${analysisId}`);
                        const data = await response.json();

                        if (data.status === 'completed' && data.success) {
                            showResults(data.result);
                            return;
                        } else if (data.status === 'error' || !data.success) {
                            showError(data.message || 'Fehler bei der Analyse');
                            return;
                        } else if (data.status === 'running') {
                            attempts++;
                            if (attempts >= maxAttempts) {
                                showError('Timeout: Analyse dauert zu lange');
                                return;
                            }
                            setTimeout(poll, 1000);
                        } else {
                            showError('Unbekannter Status: ' + data.status);
                        }
                    } catch (error) {
                        console.error('Polling error:', error);
                        showError('Fehler beim Abrufen der Ergebnisse: ' + error.message);
                    }
                };

                poll();
            }

            // Show loading state
            function showLoading() {
                resultsContent.style.display = 'none';
                errorState.style.display = 'none';
                loadingState.style.display = 'block';
                progressFill.style.width = '0%';
                statusText.textContent = 'Initialisierung...';
                document.getElementById('analyzeBtn').disabled = true;
            }

            // Simulate progress
            function simulateProgress() {
                const stages = [
                    { percent: 10, text: 'Verbindung zum LLM-Provider...' },
                    { percent: 25, text: 'Analysten werden initialisiert...' },
                    { percent: 40, text: 'Marktdaten werden abgerufen...' },
                    { percent: 60, text: 'Analysten arbeiten...' },
                    { percent: 80, text: 'Debatte l√§uft...' },
                    { percent: 95, text: 'Finale Empfehlung wird erstellt...' }
                ];

                let currentStage = 0;
                const interval = setInterval(() => {
                    if (currentStage < stages.length) {
                        const stage = stages[currentStage];
                        progressFill.style.width = stage.percent + '%';
                        statusText.textContent = stage.text;
                        currentStage++;
                    } else {
                        clearInterval(interval);
                    }
                }, 2000);
            }

            // Show results
            function showResults(result) {
                loadingState.style.display = 'none';
                errorState.style.display = 'none';
                resultsContent.style.display = 'block';
                document.getElementById('analyzeBtn').disabled = false;

                let decision = 'HALTEN';
                let decisionClass = 'hold';
                
                if (result.decision) {
                    const decisionText = result.decision.toLowerCase();
                    if (decisionText.includes('kaufen') || decisionText.includes('buy')) {
                        decision = 'KAUFEN';
                        decisionClass = 'buy';
                    } else if (decisionText.includes('verkaufen') || decisionText.includes('sell')) {
                        decision = 'VERKAUFEN';
                        decisionClass = 'sell';
                    }
                }

                resultsContent.innerHTML = `
                    <div class="result-card">
                        <h3><i class="fas fa-chart-line"></i> Handelsentscheidung</h3>
                        <div class="decision ${decisionClass}">
                            ${decision}
                        </div>
                        <div class="result-details">
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    </div>
                `;
            }

            // Show error
            function showError(message) {
                loadingState.style.display = 'none';
                resultsContent.style.display = 'none';
                errorState.style.display = 'block';
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('analyzeBtn').disabled = false;
            }
            
            // Auto-save form data to localStorage
            let formSaveTimeout;
            function saveFormData() {
                const formData = {
                    ticker: document.getElementById('ticker').value,
                    date: document.getElementById('date').value,
                    provider: providerSelect.value,
                    quickModel: quickModelSelect.value,
                    deepModel: deepModelSelect.value,
                    depth: depthSlider.value,
                    discordWebhook: discordWebhookInput.value,
                    discordNotify: document.getElementById('discordNotify').checked,
                    analystMarket: document.getElementById('analystMarket').checked,
                    analystSocial: document.getElementById('analystSocial').checked,
                    analystNews: document.getElementById('analystNews').checked,
                    analystFundamentals: document.getElementById('analystFundamentals').checked
                };
                localStorage.setItem('tradingagents_formdata', JSON.stringify(formData));
                console.log('üíæ Formulardaten gespeichert');
            }

            function loadFormData() {
                const savedData = localStorage.getItem('tradingagents_formdata');
                if (savedData) {
                    try {
                        const formData = JSON.parse(savedData);
                        
                        if (formData.ticker) document.getElementById('ticker').value = formData.ticker;
                        if (formData.date) document.getElementById('date').value = formData.date;
                        if (formData.discordWebhook) discordWebhookInput.value = formData.discordWebhook;
                        if (formData.discordNotify !== undefined) document.getElementById('discordNotify').checked = formData.discordNotify;
                        if (formData.depth) {
                            depthSlider.value = formData.depth;
                            depthValue.textContent = formData.depth;
                        }
                        
                        if (formData.analystMarket !== undefined) document.getElementById('analystMarket').checked = formData.analystMarket;
                        if (formData.analystSocial !== undefined) document.getElementById('analystSocial').checked = formData.analystSocial;
                        if (formData.analystNews !== undefined) document.getElementById('analystNews').checked = formData.analystNews;
                        if (formData.analystFundamentals !== undefined) document.getElementById('analystFundamentals').checked = formData.analystFundamentals;
                        
                        if (formData.provider) {
                            setTimeout(() => {
                                providerSelect.value = formData.provider;
                                loadModels(formData.provider);
                                
                                setTimeout(() => {
                                    if (formData.quickModel) quickModelSelect.value = formData.quickModel;
                                    if (formData.deepModel) deepModelSelect.value = formData.deepModel;
                                }, 200);
                            }, 200);
                        }
                        
                        console.log('üì• Formulardaten wiederhergestellt');
                    } catch (e) {
                        console.error('Fehler beim Laden der Formulardaten:', e);
                    }
                }
            }

            function attachAutoSaveListeners() {
                const formElements = [
                    'ticker', 'date', 'discordWebhook', 'discordNotify',
                    'analystMarket', 'analystSocial', 'analystNews', 'analystFundamentals'
                ];
                
                formElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', () => {
                            clearTimeout(formSaveTimeout);
                            formSaveTimeout = setTimeout(saveFormData, 500);
                        });
                        element.addEventListener('change', saveFormData);
                    }
                });
                
                providerSelect.addEventListener('change', saveFormData);
                quickModelSelect.addEventListener('change', saveFormData);
                deepModelSelect.addEventListener('change', saveFormData);
                depthSlider.addEventListener('input', () => {
                    clearTimeout(formSaveTimeout);
                    formSaveTimeout = setTimeout(saveFormData, 500);
                });
                
                console.log('‚úÖ Auto-Save Listeners aktiviert');
            }
        });
    </script>
</body>
</html>
